<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KurdeStore Pro Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
        body { background-color: #0f0f0f; color: white; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 700px; display: flex; flex-direction: column; gap: 25px; }
        .box { background: #1a1a1a; padding: 25px; border-radius: 18px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { margin: 0 0 20px 0; color: #0a84ff; display: flex; align-items: center; gap: 10px; font-size: 22px; }
        #status-box { display: none; margin-bottom: 20px; padding: 15px; border-radius: 12px; background: #000; border-left: 4px solid #0a84ff; font-family: monospace; font-size: 13px; color: #30d158; }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; background: #252525; border: 1px solid #333; color: white; border-radius: 10px; box-sizing: border-box; font-family: inherit; }
        textarea { height: 80px; resize: vertical; }
        
        .label { font-size: 11px; color: #888; font-weight: bold; text-transform: uppercase; margin-top: 10px; display: block; }
        .primary-btn { width: 100%; padding: 15px; background: #0a84ff; color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 15px; transition: 0.2s; }
        .primary-btn:hover { background: #0070e0; }
        .cancel-btn { background: #333; margin-top: 10px; display: none; }
        .cancel-btn:hover { background: #444; }
        
        .bar-container { width: 100%; height: 6px; background: #333; border-radius: 10px; margin: 5px 0 15px 0; overflow: hidden; }
        .bar { height: 100%; background: #0a84ff; width: 0%; transition: width 0.4s ease; box-shadow: 0 0 10px #0a84ff; }
        
        .app-item { display: flex; align-items: center; background: #222; padding: 15px; margin-bottom: 12px; border-radius: 14px; border: 1px solid #333; }
        .app-icon { width: 55px; height: 55px; border-radius: 12px; object-fit: cover; margin-right: 15px; background: #333; }
        .app-info { flex: 1; }
        .app-name { font-weight: bold; font-size: 17px; }
        .app-subtitle { font-size: 13px; color: #0a84ff; margin-bottom: 2px; }
        .app-meta { font-size: 12px; color: #777; }
        
        .btn-group { display: flex; gap: 8px; }
        .edit-btn { background: #0a84ff20; color: #0a84ff; border: 1px solid #0a84ff40; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .delete-btn { background: #ff3b3020; color: #ff3b30; border: 1px solid #ff3b3040; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="box">
        <h2 id="formTitle">üöÄ Upload App</h2>
        <div id="status-box">Ready to sync...</div>

        <input type="hidden" id="originalIpaKey">
        <input type="hidden" id="originalIconKey">
        <input type="hidden" id="originalFullIconUrl"> 
        <span class="label">Files</span>
        <div id="iconInputContainer">
            <input type="file" id="iconFile" accept="image/*" placeholder="Icon (Optional on Update)">
            <div class="bar-container"><div class="bar" id="iconBar"></div></div>
        </div>
        
        <input type="file" id="ipaFile" accept=".ipa" onchange="handleIpaSelection()">
        <div class="bar-container"><div class="bar" id="ipaBar"></div></div>

        <span class="label">Metadata</span>
        <input type="text" id="name" placeholder="Display Name">
        <input type="text" id="info" placeholder="Subtitle"> 
        <textarea id="desc" placeholder="Full Description / Features"></textarea>
        
        <span class="label">System Info</span>
        <input type="text" id="bundleId" placeholder="Bundle ID (Auto-Detects)">
        <div style="display: flex; gap: 10px;">
            <input type="text" id="version" placeholder="Version">
            <input type="text" id="size" placeholder="Size" readonly>
        </div>

        <select id="isGame">
            <option value="false">üì± Application</option>
            <option value="true">üéÆ Game</option>
        </select>

        <button onclick="startUpload()" id="btn" class="primary-btn">Upload to Store</button>
        <button onclick="resetForm()" id="cancelBtn" class="primary-btn cancel-btn">Cancel Update</button>
    </div>

    <div class="box">
        <h2>üì¶ Manage Store</h2>
        <input type="text" id="searchInput" style="width:100%; margin-bottom:20px;" placeholder="Search..." oninput="filterList()">
        <div id="appsList"></div>
        <div id="gamesList"></div>
    </div>
</div>

<script>
    const API_URL = "https://api.kurde.store/store-api";
    const S3_BASE_URL = "https://my-app-store.lon1.digitaloceanspaces.com";
    
    // üö® FIX 2: Built-in safe SVG image. No more via.placeholder.com errors!
    const SAFE_PLACEHOLDER = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NSIgaGVpZ2h0PSI1NSIgdmlld0JveD0iMCAwIDU1IDU1Ij48cmVjdCB3aWR0aD0iNTUiIGhlaWdodD0iNTUiIGZpbGw9IiMzMzMiIHJ4PSIxMiIvPjx0ZXh0IHg9IjI3LjUiIHk9IjMzIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+QXBwPC90ZXh0Pjwvc3ZnPg==';

    let allData = [];
    let isEditing = false;

    window.onload = loadApps;

    async function handleIpaSelection() {
        const file = document.getElementById('ipaFile').files[0];
        if (!file) return;
        
        document.getElementById('size').value = (file.size / (1024 * 1024)).toFixed(1) + " MB";
        updateStatus("Scanning IPA for Bundle ID...");

        try {
            if (typeof JSZip === 'undefined') {
                throw new Error("JSZip failed to load. Ad-blocker might be active.");
            }

            const zip = await JSZip.loadAsync(file);
            // Search for Info.plist inside the Payload folder
            const plistFile = Object.keys(zip.files).find(path => path.match(/Payload\/[^\/]+\.app\/Info\.plist$/));
            
            if (plistFile && !isEditing) {
                const content = await zip.files[plistFile].async("string");
                
                // Extract using Regex
                let bMatch = content.match(/<key>CFBundleIdentifier<\/key>[\s\S]*?<string>(.*?)<\/string>/);
                let vMatch = content.match(/<key>CFBundleShortVersionString<\/key>[\s\S]*?<string>(.*?)<\/string>/);
                let nMatch = content.match(/<key>CFBundleDisplayName<\/key>[\s\S]*?<string>(.*?)<\/string>/) || content.match(/<key>CFBundleName<\/key>[\s\S]*?<string>(.*?)<\/string>/);
                
                if (bMatch && bMatch[1]) document.getElementById('bundleId').value = bMatch[1];
                if (vMatch && vMatch[1]) document.getElementById('version').value = vMatch[1];
                if (nMatch && nMatch[1] && !document.getElementById('name').value) document.getElementById('name').value = nMatch[1];
                
                updateStatus("‚úÖ Bundle ID Auto-Detected: " + (bMatch ? bMatch[1] : "Unknown"));
            } else {
                updateStatus("‚ö†Ô∏è Could not find Info.plist in IPA", true);
            }
        } catch (e) { 
            console.error(e);
            updateStatus("‚ö†Ô∏è Scan Error: " + e.message, true); 
        }
    }

    async function startUpload() {
        const btn = document.getElementById('btn');
        const iconFile = document.getElementById('iconFile').files[0];
        const ipaFile = document.getElementById('ipaFile').files[0];
        const name = document.getElementById('name').value;
        const bId = document.getElementById('bundleId').value;

        if(!name || !bId) return updateStatus("‚ùå Name and BundleID required", true);
        if(!isEditing && (!iconFile || !ipaFile)) return updateStatus("‚ùå New apps need both Icon and IPA", true);

        btn.disabled = true;
        updateStatus(isEditing ? "Updating..." : "Uploading...");

        try {
            let iconKey = document.getElementById('originalIconKey').value;
            let ipaKey = document.getElementById('originalIpaKey').value;
            let oldIconUrl = document.getElementById('originalFullIconUrl').value;

            let finalIconUrl = "";
            
            if (iconFile) {
                updateStatus("Uploading New Icon...");
                iconKey = await uploadFile(iconFile, 'icons', 'iconBar');
                finalIconUrl = S3_BASE_URL + "/" + iconKey;
            } else {
                if (iconKey) {
                    finalIconUrl = S3_BASE_URL + "/" + iconKey;
                } else {
                    finalIconUrl = oldIconUrl;
                }
            }

            let finalIpaUrl = "";
            if (ipaFile) {
                updateStatus("Uploading New IPA...");
                ipaKey = await uploadFile(ipaFile, 'apps', 'ipaBar');
                finalIpaUrl = S3_BASE_URL + "/" + ipaKey;
            } else {
                if (ipaKey) finalIpaUrl = S3_BASE_URL + "/" + ipaKey;
            }

            const payload = {
                action: "save_item",
                name: name,
                info: document.getElementById('info').value,
                desc: document.getElementById('desc').value,
                bundleId: bId,
                appId: bId,
                version: document.getElementById('version').value,
                size: document.getElementById('size').value,
                isGame: document.getElementById('isGame').value === "true",
                iconKey: iconKey,
                ipaKey: ipaKey,
                icon: finalIconUrl,
                ipa: finalIpaUrl
            };

            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });

            updateStatus("‚úÖ App Updated Successfully!");
            setTimeout(() => location.reload(), 1500);
        } catch (err) { updateStatus("‚ùå Error: " + err.message, true); btn.disabled = false; }
    }

    async function uploadFile(file, folder, barId) {
        const bar = document.getElementById(barId);
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'get_url', fileName: file.name, fileType: folder, contentType: file.type }) });
        const { uploadUrl, key } = await res.json();
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('PUT', uploadUrl);
            xhr.setRequestHeader('Content-Type', file.type);
            xhr.upload.onprogress = (e) => { if (e.lengthComputable) bar.style.width = (e.loaded / e.total) * 100 + "%"; };
            xhr.onload = () => (xhr.status === 200) ? resolve(key) : reject(new Error("Upload failed"));
            xhr.onerror = () => reject(new Error("Network Error"));
            xhr.send(file);
        });
    }

    async function loadApps() {
        try {
            updateStatus("Loading apps...");
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "list_apps" }) });
            if (!res.ok) throw new Error("Connection Failed");
            allData = await res.json();
            renderLists(allData);
            updateStatus("Ready");
        } catch (e) { console.error(e); updateStatus("‚ùå Load Failed: " + e.message, true); }
    }

    function renderLists(items) {
        const aList = document.getElementById('appsList');
        const gList = document.getElementById('gamesList');
        aList.innerHTML = "<h3>üì± Applications</h3>"; gList.innerHTML = "<h3>üéÆ Games</h3>";
        
        if (!items || items.length === 0) {
            aList.innerHTML += "<p>No apps found.</p>"; return;
        }

        items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'app-item';
            
            // Apply Safe Placeholder here
            let iconSrc = item.icon || (item.iconKey ? (S3_BASE_URL + "/" + item.iconKey) : SAFE_PLACEHOLDER);
            const itemString = encodeURIComponent(JSON.stringify(item));

            card.innerHTML = `
                <img src="${iconSrc}" class="app-icon" onerror="this.src='${SAFE_PLACEHOLDER}'">
                <div class="app-info">
                    <div class="app-name">${item.name}</div>
                    <div class="app-subtitle">${item.info || ''}</div> 
                    <div class="app-meta">${item.version} ‚Ä¢ ${item.size || 'Unknown'}</div>
                </div>
                <div class="btn-group">
                    <button onclick="editApp('${itemString}')" class="edit-btn">Edit</button>
                    <button onclick="deleteApp('${item.appId || item.bundleId}', '${item.name}')" class="delete-btn">Delete</button>
                </div>
            `;
            (String(item.isGame) === "true") ? gList.appendChild(card) : aList.appendChild(card);
        });
    }

    function editApp(encodedItem) {
        const item = JSON.parse(decodeURIComponent(encodedItem));
        isEditing = true;
        
        document.getElementById('formTitle').innerText = "üîÑ Update: " + item.name;
        document.getElementById('btn').innerText = "Update App";
        document.getElementById('cancelBtn').style.display = "inline-block";
        document.getElementById('iconFile').style.opacity = "0.5"; 
        
        document.getElementById('name').value = item.name;
        document.getElementById('info').value = item.info || "";
        document.getElementById('desc').value = item.desc || "";
        document.getElementById('bundleId').value = item.bundleId || item.appId;
        document.getElementById('version').value = item.version || "";
        document.getElementById('size').value = item.size || "";
        document.getElementById('isGame').value = String(item.isGame);
        
        document.getElementById('originalIconKey').value = item.iconKey || "";
        document.getElementById('originalIpaKey').value = item.ipaKey || "";
        document.getElementById('originalFullIconUrl').value = item.icon || ""; 

        document.getElementById('bundleId').readOnly = true;
        document.getElementById('bundleId').style.opacity = "0.6";
        
        updateStatus("‚ö†Ô∏è Update Mode: Just upload new IPA to update.");
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetForm() { location.reload(); }

    async function deleteApp(id, name) {
        if (confirm(`Delete ${name}?`)) {
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "delete_app", bundleId: id }) });
            loadApps();
        }
    }

    function filterList() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        renderLists(allData.filter(i => (i.name || "").toLowerCase().includes(q)));
    }

    function updateStatus(m, e=false) {
        const b = document.getElementById('status-box');
        b.style.display = 'block'; b.style.color = e ? '#ff3b30' : '#30d158';
        b.innerHTML = "> " + m;
    }
</script>
</body>
</html>
