<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KurdeStore Admin</title>
    <style>
        body { background-color: #121212; color: white; font-family: -apple-system, system-ui, sans-serif; display: flex; justify-content: center; padding: 50px; }
        .container { width: 400px; background: #1e1e1e; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h2 { text-align: center; color: #007aff; }
        input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; background: #2c2c2c; border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #007aff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #555; }
        .progress { height: 4px; background: #333; margin-top: 5px; border-radius: 2px; overflow: hidden; }
        .bar { height: 100%; background: #00d60f; width: 0%; transition: width 0.2s; }
        .status { font-size: 12px; color: #888; margin-top: 5px; text-align: right; }
    </style>
</head>
<body>

<div class="container">
    <h2>Upload App</h2>
    
    <label>App Icon (.png/.jpg)</label>
    <input type="file" id="iconFile" accept="image/*">
    <div class="progress"><div class="bar" id="iconBar"></div></div>

    <label>App File (.ipa)</label>
    <input type="file" id="ipaFile" accept=".ipa">
    <div class="progress"><div class="bar" id="ipaBar"></div></div>

    <hr style="border-color: #333; margin: 20px 0;">

    <input type="text" id="appName" placeholder="App Name (e.g. Video Star)">
    <input type="text" id="bundleId" placeholder="Bundle ID (e.g. com.videostar)">
    <input type="text" id="version" placeholder="Version (e.g. 1.0)">
    <input type="text" id="size" placeholder="Size (e.g. 50MB)">
    <textarea id="desc" placeholder="Description..." rows="3"></textarea>
    
    <select id="type">
        <option value="false">App</option>
        <option value="true">Game</option>
    </select>

    <button onclick="startUpload()" id="uploadBtn">üöÄ Upload to Store</button>
    <p class="status" id="finalStatus"></p>
</div>

<script>
    // ‚ö†Ô∏è PASTE YOUR LAMBDA FUNCTION URL HERE
    const API_URL = "YOUR_LAMBDA_URL_HERE"; 

    async function startUpload() {
        const btn = document.getElementById('uploadBtn');
        const status = document.getElementById('finalStatus');
        const iconFile = document.getElementById('iconFile').files[0];
        const ipaFile = document.getElementById('ipaFile').files[0];

        if (!iconFile || !ipaFile) return alert("Please select both Icon and IPA files.");
        
        btn.disabled = true;
        btn.innerText = "‚è≥ Uploading Files...";

        try {
            // 1. Upload Icon
            status.innerText = "Uploading Icon...";
            const iconKey = await uploadFile(iconFile, 'icons', 'iconBar');

            // 2. Upload IPA
            status.innerText = "Uploading IPA (This may take time)...";
            const ipaKey = await uploadFile(ipaFile, 'apps', 'ipaBar');

            // 3. Save Data to DynamoDB
            status.innerText = "Saving to Database...";
            
            const data = {
                action: "save_item",
                name: document.getElementById('appName').value,
                bundleId: document.getElementById('bundleId').value,
                version: document.getElementById('version').value,
                size: document.getElementById('size').value,
                desc: document.getElementById('desc').value,
                isGame: document.getElementById('type').value === "true",
                iconKey: iconKey,
                ipaKey: ipaKey
            };

            const response = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(data)
            });

            if (response.ok) {
                alert("‚úÖ Success! App added to store.");
                location.reload();
            } else {
                throw new Error("Database save failed");
            }

        } catch (error) {
            console.error(error);
            alert("‚ùå Error: " + error.message);
            btn.disabled = false;
            btn.innerText = "Try Again";
        }
    }

    async function uploadFile(file, folder, barId) {
        // A. Get Presigned URL
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "get_url",
                fileName: file.name,
                fileType: folder,
                contentType: file.type
            })
        });
        const { uploadUrl, key } = await res.json();

        // B. Upload Direct to S3
        await fetch(uploadUrl, {
            method: "PUT",
            body: file,
            headers: { "Content-Type": file.type }
        });

        document.getElementById(barId).style.width = "100%";
        return key;
    }
</script>

</body>
</html>
