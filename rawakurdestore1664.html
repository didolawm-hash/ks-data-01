<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KurdeStore Pro Admin</title>
    <style>
        body { background-color: #0f0f0f; color: white; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 700px; display: flex; flex-direction: column; gap: 25px; }
        .box { background: #1a1a1a; padding: 25px; border-radius: 18px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { margin: 0 0 20px 0; color: #0a84ff; display: flex; align-items: center; gap: 10px; font-size: 22px; }
        
        .search-container { margin-bottom: 20px; }
        .search-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #333; background: #252525; color: white; outline: none; box-sizing: border-box; }
        .search-input:focus { border-color: #0a84ff; }

        input, select { width: 100%; padding: 12px; margin: 8px 0; background: #252525; border: 1px solid #333; color: white; border-radius: 10px; box-sizing: border-box; }
        .label { font-size: 11px; color: #888; font-weight: bold; text-transform: uppercase; margin-top: 10px; display: block; }
        
        .primary-btn { width: 100%; padding: 15px; background: #0a84ff; color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 15px; transition: 0.2s; }
        .primary-btn:hover { background: #0070e0; }
        .primary-btn:disabled { background: #444; cursor: not-allowed; }

        h3 { font-size: 14px; color: #555; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 5px; margin-top: 30px; }
        
        .app-item { display: flex; align-items: center; background: #222; padding: 15px; margin-bottom: 12px; border-radius: 14px; border: 1px solid #333; }
        .app-icon { width: 55px; height: 55px; border-radius: 12px; object-fit: cover; margin-right: 15px; background: #000; }
        .app-info { flex: 1; }
        .app-name { font-weight: bold; font-size: 17px; }
        .app-meta { font-size: 12px; color: #777; margin-top: 3px; }

        .delete-btn { background: #ff3b3020; color: #ff3b30; border: 1px solid #ff3b3040; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .delete-btn:hover { background: #ff3b30; color: white; }

        .bar-container { width: 100%; height: 4px; background: #333; border-radius: 2px; margin-top: 5px; overflow: hidden; }
        .bar { height: 100%; background: #30d158; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

<div class="container">
    <div class="box">
        <h2>ðŸš€ Upload App</h2>
        <span class="label">Icon Selection</span>
        <input type="file" id="iconFile" accept="image/*">
        <div class="bar-container"><div class="bar" id="iconBar"></div></div>
        
        <span class="label">IPA Selection</span>
        <input type="file" id="ipaFile" accept=".ipa" onchange="autoFillSize()">
        <div class="bar-container"><div class="bar" id="ipaBar"></div></div>

        <span class="label">Details</span>
        <input type="text" id="name" placeholder="App Name" oninput="autoGenerateId()">
        <input type="text" id="bundleId" placeholder="Bundle ID">
        <div style="display: flex; gap: 10px;">
            <input type="text" id="version" placeholder="Version" value="1.0">
            <input type="text" id="size" placeholder="Size" readonly>
        </div>

        <select id="isGame">
            <option value="false">ðŸ“± Application</option>
            <option value="true">ðŸŽ® Game</option>
        </select>

        <button onclick="startUpload()" id="btn" class="primary-btn">Upload to Store</button>
    </div>

    <div class="box">
        <h2>ðŸ“¦ Manage Store</h2>
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Search apps or games..." oninput="filterList()">
        </div>

        <h3>ðŸ“± Applications</h3>
        <div id="appsList"></div>

        <h3>ðŸŽ® Games</h3>
        <div id="gamesList"></div>
    </div>
</div>

<script>
    const API_URL = "https://xzkstdqajamnvervpc6ohennbe0durgb.lambda-url.eu-west-2.on.aws/";
    let allData = [];

    window.onload = loadApps;

    async function loadApps() {
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "list_apps" }) });
            allData = await res.json();
            renderLists(allData);
        } catch (err) {
            console.error("Load error:", err);
        }
    }

    function renderLists(items) {
        const appsDiv = document.getElementById('appsList');
        const gamesDiv = document.getElementById('gamesList');
        appsDiv.innerHTML = ""; gamesDiv.innerHTML = "";

        items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'app-item';
            
            // --- THE ICON FIX ---
            // 1. Get the raw key (e.g., "icons/123_img.png")
            let rawKey = item.iconKey || "";
            // 2. Remove any extra "icons/" prefix if it's already there
            let cleanFileName = rawKey.split('/').pop(); 
            // 3. Build the final URL
            const iconSrc = `https://kurde-store-data.s3.eu-west-2.amazonaws.com/icons/${cleanFileName}`;
            
            card.innerHTML = `
                <img src="${iconSrc}" class="app-icon" 
                     onerror="this.onerror=null; this.src='https://via.placeholder.com/55?text=Error';">
                <div class="app-info">
                    <div class="app-name">${item.name}</div>
                    <div class="app-meta">${item.version} â€¢ ${item.size}</div>
                    <div class="app-meta" style="color:#444; font-size: 10px;">${item.appId}</div>
                </div>
                <button onclick="deleteApp('${item.appId}', '${item.name}')" class="delete-btn">Delete</button>
            `;

            if (item.isGame === "true" || item.isGame === true) {
                gamesDiv.appendChild(card);
            } else {
                appsDiv.appendChild(card);
            }
        });
    }

    function filterList() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        renderLists(allData.filter(i => i.name.toLowerCase().includes(query)));
    }

    async function deleteApp(id, name) {
        if (!confirm(`Delete ${name}?`)) return;
        try {
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "delete_app", bundleId: id }) });
            loadApps();
        } catch (e) { alert("Delete failed"); }
    }

    function autoGenerateId() {
        const name = document.getElementById('name').value;
        document.getElementById('bundleId').value = "com.kurdestore." + name.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
    }

    function autoFillSize() {
        const file = document.getElementById('ipaFile').files[0];
        if (file) document.getElementById('size').value = (file.size / (1024 * 1024)).toFixed(1) + " MB";
    }

    async function startUpload() {
        const btn = document.getElementById('btn');
        const iconFile = document.getElementById('iconFile').files[0];
        const ipaFile = document.getElementById('ipaFile').files[0];

        if(!iconFile || !ipaFile || !document.getElementById('name').value) {
            return alert("Please select files and enter a name.");
        }

        btn.disabled = true; btn.innerText = "Uploading...";

        try {
            const iconKey = await uploadFile(iconFile, 'icons', 'iconBar');
            const ipaKey = await uploadFile(ipaFile, 'apps', 'ipaBar');

            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: "save_item",
                    name: document.getElementById('name').value,
                    bundleId: document.getElementById('bundleId').value,
                    version: document.getElementById('version').value,
                    size: document.getElementById('size').value,
                    isGame: document.getElementById('isGame').value,
                    iconKey: iconKey,
                    ipaKey: ipaKey
                })
            });
            
            btn.innerText = "âœ… Success!";
            setTimeout(() => location.reload(), 1000);
        } catch (err) {
            alert("Upload failed! Check Console.");
            console.error(err);
            btn.disabled = false;
            btn.innerText = "Upload to Store";
        }
    }

    async function uploadFile(file, folder, barId) {
        const res = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'get_url', fileName: file.name, fileType: folder, contentType: file.type })
        });
        const { uploadUrl, key } = await res.json();
        
        // Progress bar logic
        await fetch(uploadUrl, { 
            method: 'PUT', 
            body: file, 
            headers: { 'Content-Type': file.type } 
        });
        
        document.getElementById(barId).style.width = "100%";
        return key;
    }
</script>
</body>
</html>
