<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KurdeStore Admin Panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { background-color: #121212; color: white; font-family: sans-serif; display: flex; justify-content: center; padding-top: 50px; }
        .box { width: 400px; background: #1e1e1e; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h2 { text-align: center; color: #0a84ff; }
        input, textarea, select { width: 100%; padding: 10px; margin: 8px 0; background: #2c2c2c; border: 1px solid #333; color: white; border-radius: 6px; box-sizing: border-box; }
        .label { font-size: 12px; color: #aaa; margin-top: 10px; display: block; }
        button { width: 100%; padding: 12px; background: #0a84ff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        button:hover { background: #0070e0; }
        button:disabled { background: #444; cursor: not-allowed; }
        .bar-container { width: 100%; height: 4px; background: #333; margin-top: 5px; border-radius: 2px; }
        .bar { height: 100%; background: #30d158; width: 0%; transition: width 0.2s; }
        
        .scanning { border-color: #0a84ff !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(10, 132, 255, 0.4); } 70% { box-shadow: 0 0 0 5px rgba(10, 132, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(10, 132, 255, 0); } }
    </style>
</head>
<body>

<div class="box">
    <h2>üöÄ Upload App</h2>

    <span class="label">1. Select App Icon (.png)</span>
    <input type="file" id="iconFile" accept="image/*">
    <div class="bar-container"><div class="bar" id="iconBar"></div></div>

    <span class="label">2. Select IPA File (.ipa)</span>
    <input type="file" id="ipaFile" accept=".ipa" onchange="readIpaLightweight()">
    <div class="bar-container"><div class="bar" id="ipaBar"></div></div>

    <hr style="border-color: #333; margin: 20px 0;">

    <input type="text" id="name" placeholder="App Name (e.g. Video Star)">
    
    <input type="text" id="bundleId" placeholder="Bundle ID (e.g. com.videostar)">
    <input type="text" id="version" placeholder="Version (e.g. 1.2)">
    <input type="text" id="size" placeholder="Size (e.g. 55MB)">
    
    <textarea id="desc" rows="3" placeholder="Description..."></textarea>

    <select id="isGame">
        <option value="false">App</option>
        <option value="true">Game</option>
    </select>

    <button onclick="startUpload()" id="btn">Upload to Store</button>
</div>

<script>
    // ‚ö†Ô∏è PASTE YOUR LAMBDA URL HERE!
    const API_URL = "https://xzkstdqajamnvervpc6ohennbe0durgb.lambda-url.eu-west-2.on.aws/"; 

    async function readIpaLightweight() {
        const fileInput = document.getElementById('ipaFile');
        const file = fileInput.files[0];
        if (!file) return;

        const bundleInput = document.getElementById('bundleId');
        const versionInput = document.getElementById('version');
        const sizeInput = document.getElementById('size');

        // 1. Calculate Size (Instant)
        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1); 
        sizeInput.value = fileSizeMB + " MB";

        bundleInput.placeholder = "Searching inside IPA...";
        bundleInput.classList.add('scanning');

        try {
            // 2. Load ZIP Directory (Does NOT read the whole file)
            const zip = new JSZip();
            const zipContent = await zip.loadAsync(file);

            // 3. Find Info.plist anywhere in the zip
            let plistFile = null;
            
            // Search for "Payload/Something.app/Info.plist"
            zipContent.forEach((relativePath, zipEntry) => {
                if (relativePath.endsWith("Info.plist") && relativePath.includes("Payload/")) {
                    // Check if it's the main app, not a framework/plugin
                    // A main app path usually looks like: Payload/App.app/Info.plist (2 levels deep)
                    const parts = relativePath.split('/');
                    if (parts.length === 3) {
                        plistFile = zipEntry;
                    }
                }
            });

            // If we couldn't find the main one, just grab the first Info.plist found
            if (!plistFile) {
                zipContent.forEach((relativePath, zipEntry) => {
                    if (relativePath.endsWith("Info.plist")) plistFile = zipEntry;
                });
            }

            if (!plistFile) throw new Error("Could not find Info.plist inside IPA");

            // 4. Read Info.plist as text
            const plistText = await plistFile.async("string");

            // 5. Parse using Regex (Works for XML Plists - common in decrypted apps)
            // Look for <key>CFBundleIdentifier</key> ... <string>VALUE</string>
            const bundleMatch = plistText.match(/CFBundleIdentifier<\/key>[\s\S]*?<string>(.*?)<\/string>/);
            const versionMatch = plistText.match(/CFBundleShortVersionString<\/key>[\s\S]*?<string>(.*?)<\/string>/);

            if (bundleMatch && bundleMatch[1]) {
                bundleInput.value = bundleMatch[1];
            } else {
                // If regex failed, it might be Binary Plist (bplist)
                if (plistText.startsWith("bplist")) {
                    alert("Info: This IPA uses a Binary Plist. Please enter Bundle ID manually.");
                } else {
                    bundleInput.value = "Unknown";
                }
            }

            if (versionMatch && versionMatch[1]) {
                versionInput.value = versionMatch[1];
            } else {
                versionInput.value = "1.0";
            }

        } catch (err) {
            console.error(err);
            // Don't annoy the user with an alert, just let them type
            bundleInput.placeholder = "Enter Bundle ID";
            versionInput.placeholder = "Enter Version";
        } finally {
            bundleInput.classList.remove('scanning');
        }
    }

    async function startUpload() {
        const btn = document.getElementById('btn');
        const iconFile = document.getElementById('iconFile').files[0];
        const ipaFile = document.getElementById('ipaFile').files[0];

        if (!iconFile || !ipaFile) return alert("Please select both files!");
        if (!document.getElementById('name').value) return alert("Enter a name!");

        btn.disabled = true;
        btn.innerText = "‚è≥ Uploading...";

        try {
            // 1. Upload Icon
            const iconKey = await uploadFile(iconFile, 'icons', 'iconBar');
            
            // 2. Upload IPA
            const ipaKey = await uploadFile(ipaFile, 'apps', 'ipaBar');

            // 3. Save to DynamoDB
            btn.innerText = "üíæ Saving...";
            
            const data = {
                action: "save_item",
                name: document.getElementById('name').value,
                bundleId: document.getElementById('bundleId').value,
                version: document.getElementById('version').value,
                size: document.getElementById('size').value,
                desc: document.getElementById('desc').value,
                isGame: document.getElementById('isGame').value === 'true',
                iconKey: iconKey,
                ipaKey: ipaKey
            };

            const res = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (res.ok) {
                alert("‚úÖ Success! App added to store.");
                location.reload();
            } else {
                alert("‚ùå Database Error!");
            }

        } catch (err) {
            console.error(err);
            alert("Error: " + err.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "Upload to Store";
        }
    }

    async function uploadFile(file, folder, barId) {
        const res = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'get_url',
                fileName: file.name,
                fileType: folder,
                contentType: file.type
            })
        });
        const { uploadUrl, key } = await res.json();

        await fetch(uploadUrl, {
            method: 'PUT',
            body: file,
            headers: { 'Content-Type': file.type }
        });

        document.getElementById(barId).style.width = "100%";
        return key;
    }
</script>

</body>
</html>
