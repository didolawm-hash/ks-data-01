<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Kurde Store - Member Area</title>
    <style>
        :root { --ios-blue: #007aff; --ios-gray: #8e8e93; --ios-bg: #f2f2f7; }
        /* Hidden by default for security */
        body { font-family: -apple-system, sans-serif; background-color: var(--ios-bg); margin: 0; padding-bottom: 50px; display: none; }
        
        .header { background: white; padding: 40px 20px 20px; border-bottom: 1px solid #d1d1d6; }
        .header h1 { font-size: 34px; margin: 0; font-weight: 700; }
        #date-today { color: var(--ios-gray); margin: 5px 0 0; font-size: 13px; text-transform: uppercase; }

        .search-container { padding: 10px 15px; position: sticky; top: 0; background: var(--ios-bg); z-index: 100; border-bottom: 0.5px solid #d1d1d6; }
        .search-bar { width: 100%; padding: 12px; border-radius: 12px; border: none; background: #e3e3e8; font-size: 16px; outline: none; box-sizing: border-box; }

        .featured-container { padding: 20px 15px; overflow-x: auto; display: flex; gap: 15px; scroll-snap-type: x mandatory; }
        .featured-card { min-width: 85%; height: 160px; background: linear-gradient(135deg, #007aff, #5856d6); border-radius: 14px; color: white; padding: 20px; scroll-snap-align: start; flex-shrink: 0; }
        
        .section-title { padding: 20px 20px 10px; font-size: 22px; font-weight: 700; color: #1c1c1e; }
        .app-list { background: white; margin: 0 15px; border-radius: 14px; padding: 0 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .app-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 0.5px solid #d1d1d6; }
        .app-item:last-child { border-bottom: none; }
        .app-icon { width: 60px; height: 60px; border-radius: 14px; margin-right: 15px; object-fit: cover; border: 0.5px solid #eee; }
        .app-info { flex-grow: 1; }
        .app-name { font-weight: 600; font-size: 17px; margin-bottom: 2px; color: #000; }
        .app-sub { font-size: 12px; color: var(--ios-gray); }
        .get-btn { background: #f0f0f5; color: var(--ios-blue); padding: 6px 22px; border-radius: 20px; font-weight: 700; border: none; font-size: 14px; cursor: pointer; }
        
        #device-info { padding: 20px; font-size: 11px; color: var(--ios-gray); text-align: center; }
        #no-results { display: none; text-align: center; padding: 20px; color: var(--ios-gray); }
    </style>
</head>
<body>

    <div class="header">
        <p id="date-today"></p>
        <h1>Kurde Store</h1>
    </div>

    <div class="featured-container">
        <div class="featured-card">
            <p style="opacity: 0.8; margin: 0; font-size: 12px;">WELCOME BACK</p>
            <h3>Member Area</h3>
            <p>Enjoy premium apps and games without revokes.</p>
        </div>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" class="search-bar" placeholder="Search Apps & Games...">
    </div>

    <div id="no-results">No apps found matching your search.</div>

    <div class="section-title">Applications</div>
    <div class="app-list" id="apps-list"></div>

    <div class="section-title">Games</div>
    <div class="app-list" id="games-list"></div>

    <div id="device-info"></div>

    <script>
        // 1. CONSTANTS
        const API_URL = "https://wgcdclia51.execute-api.eu-west-2.amazonaws.com/KurdeStore_Manager";
        const urlParams = new URLSearchParams(window.location.search);
        const udid = urlParams.get('udid');
        const isAdmin = urlParams.get('admin') === 'true';

        // 2. IMMEDIATE ADMIN BYPASS
        // We run this BEFORE anything else to prevent redirects
        if (isAdmin) {
            document.body.style.display = "block";
            document.getElementById('date-today').innerText = "ADMIN ACCESS";
            console.log("Admin Bypass Active");
        }

        async function initStore() {
            if (isAdmin) {
                await loadApps();
                return;
            }

            if (!udid) {
                window.location.replace("index.html");
                return;
            }

            try {
                const authRes = await fetch(`${API_URL}/get-user?udid=${udid}`);
                if (!authRes.ok) throw new Error("Auth Server Error");
                
                const userData = await authRes.json();
                
                if (userData && (userData.status === 'paid' || userData.isPaid === true)) {
                    document.body.style.display = "block";
                    document.getElementById('date-today').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                    document.getElementById('device-info').innerText = "UDID: " + udid;
                    await loadApps();
                } else {
                    window.location.replace("index.html");
                }
            } catch (err) {
                console.error("Auth failed:", err);
                window.location.replace("index.html");
            }
        }

        async function loadApps() {
            try {
                const response = await fetch(`${API_URL}/get-apps`);
                const items = await response.json();

                const appsList = document.getElementById('apps-list');
                const gamesList = document.getElementById('games-list');
                appsList.innerHTML = '';
                gamesList.innerHTML = '';

                if (!Array.isArray(items)) return;

                items.forEach(item => {
                    const html = `
                        <div class="app-item">
                            <img src="${item.icon}" class="app-icon" onerror="this.src='https://via.placeholder.com/60'">
                            <div class="app-info">
                                <div class="app-name">${item.name}</div>
                                <div class="app-sub">v${item.version || '1.0'}</div>
                            </div>
                            <button onclick="installApp('${item.appId}', '${item.ipa}')" class="get-btn">GET</button>
                        </div>
                    `;
                    if (item.category === "Games") gamesList.innerHTML += html;
                    else appsList.innerHTML += html;
                });
            } catch (err) {
                console.error("Load failed:", err);
            }
        }

        function installApp(id, ipaUrl) {
            // itms-services redirect
            window.location.href = `itms-services://?action=download-manifest&url=${ipaUrl}`;
        }

        // Search Logic
        document.getElementById('searchInput').addEventListener('input', function() {
            let filter = this.value.toLowerCase();
            let items = document.querySelectorAll('.app-item');
            let anyVisible = false;

            items.forEach(item => {
                let text = item.querySelector('.app-name').innerText.toLowerCase();
                if (text.includes(filter)) {
                    item.style.display = "flex";
                    anyVisible = true;
                } else {
                    item.style.display = "none";
                }
            });

            document.querySelectorAll('.section-title').forEach(title => {
                let nextList = title.nextElementSibling;
                let visibleInList = Array.from(nextList.querySelectorAll('.app-item')).some(i => i.style.display !== "none");
                title.style.display = (visibleInList || filter === "") ? "block" : "none";
            });

            document.getElementById('no-results').style.display = anyVisible ? "none" : "block";
        });

        // Run on load
        window.onload = initStore;
    </script>
</body>
</html>
